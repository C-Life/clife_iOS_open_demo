!function(t,e){if("object"==typeof exports){var a=require("zepto"),n=require("widget");module.exports=e(t,n,a)}else"function"==typeof t.define&&(define.amd||define.cmd)?define(["zepto","widget"],function(a,n){return e(t,n,a)}):t.Calendar=t.Calendar||e(t,t.Widget,Zepto)}(this,function(t,e,a){function n(t){return e.call(this),this.render(t)}return n.prototype=a.extend({},e.prototype,{constructor:n,initCfg:function(t){var e=this.getToday();this.cfg={target:"body",className:"calendar",year:e.year,month:e.month,date:e.date,today:e,headText:"",todayText:"",showToday:!1,tagDates:null,dateItems:{},onPreMonth:null,onNextMonth:null,onChangeMonthBefore:null,onChangeMonth:null,onToday:null,onSelect:null,onInit:null,onReady:null,onReDrawCalendar:null},a.extend(this.cfg,t)},init:function(t){this.fire("onInit",this.getCurrDateObj())},renderUI:function(){var t=this.get("year"),e=this.get("month"),a=this.get("date"),n=this.tplCalendarWrap(),s=this.tplCalendar(t,e,a);this._$elem=n.append(s)},bindHandler:function(){this.eachBind({preMonth:"onPreMonth",nextMonth:"onNextMonth",today:"onToday",select:"onSelect",changeMonBefore:"onChangeMonthBefore",changeMonth:"onChangeMonth",init:"onInit",ready:"onReady",reDrawCalendar:"onReDrawCalendar"})},_getEventType:function(){return["on","tap"]},bindUI:function(){var t=this;this.bindHandler(),this._$elem.on("tap",".pre-mon",function(){t._preMon()}).on("tap",".next-mon",function(){t._nextMon()}).on("tap",".pre",function(){t._preMon(a(this).data("date"))}).on("tap",".next",function(){t._nextMon(a(this).data("date"))}).on("tap",".today",function(){t._onToday()}).on("tap",".date",function(e){t._onSelect(e,a(this))})},syncUI:function(){this._$elem.addClass(this.cfg.className)},ready:function(){this.fire("ready",this.getCurrDateObj())},_onSelect:function(t,e){var a=e.data("date");this.select(a,e,t)},_onToday:function(){if(!this.isToday(this.get("year"),this.get("month"),this.get("date"))){var t=this.getToday();t.year==this.get("year")&&t.month==this.get("month")?this.select(t.date):(this.reDrawCalendar(t.year,t.month,t.date),this.fire("changeMonth",this.getCurrDateObj())),this.fire("today",this.getCurrDateObj("today"))}},_preMon:function(t){this._goPreOrNextMon("pre",t)},_nextMon:function(t){this._goPreOrNextMon("next",t)},_goPreOrNextMon:function(t,e){var a=this.get("year"),n=+this.get("month");this.fire("changeMonBefore",this.getCurrDateObj(t),t);var s=this.getChangeMonthDate(a,n,t,e);this._changeMonth(s.year,s.month,s.date,t),this.fire("preMonth",this.getCurrDateObj())},_changeMonth:function(t,e,a,n,s){this.reDrawCalendar(t,e,a);this.getCurrDateObj()+this.fire("changeMonth",this.getCurrDateObj(),n)},_adjustTime:function(t,e,a){this.set("year",t).set("month",e).set("date",a)},getChangeMonthDate:function(t,e,a,n){var s;"next"===a?s=new Date(t,e):"pre"===a&&(s=new Date(t,e-2)),s&&(t=s.getFullYear(),e=s.getMonth()+1);var r=n||this.getSelectedDate(),i=this.getLastDate(t,e);return r>i&&(r=i),{year:t,month:e,date:r}},updateTitleTime:function(t,e){var a=this.find(".title-wrap");a.find(".year").html(t),a.find(".month").html(e)},tplCalendarWrap:function(){var t="";return t='<div class="calendar"><div class="cal-header">',this.cfg.showToday&&(t+='<span class="today">今天</span>'),t+='<span class="pre-mon"></span><span class="titleicon"></span><span class="title-wrap"><span class="year">'+this.get("year")+'</span> 年 <span class="month">'+this.get("month")+'</span> 月 <span class="head-text">'+this.get("headText")+'</span></span><span class="next-mon"></span></div><div class="days"><span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span></div></div>',a(t)},tplCalendar:function(t,e,n){var s,r,i,o,h=this.getDatesData(t,e),d=h.lastDate,l=h.datesArr,c=h.preMonthDates,u=a('<div class="date-wrap"></div>'),g=a('<div class="oneweek"></div>');if(this.get("tagDates"))var p=this.parseTagDates(this.get("tagDates"));for(s=0,r=c;s<r;s++)i=l[s],o=a('<span class="pre" data-date="'+i+'" data-index="'+s+'"><span>'+i+"</span></span>"),g.append(o);for(s=c,r=d+c;s<r;s++)i=l[s],o=this._tplCurrMonthItem(s,i,t,e,n,p),g.append(o),s%7===6&&(u.append(g),g=a('<div class="oneweek"></div>'));for(s=d+c,r=l.length;s<r;s++)i=l[s],o=a('<span class="next" data-date="'+i+'" data-index="'+s+'"><span>'+i+"</span></span>"),g.append(o),s===r-1&&u.append(g);return u},_tplCurrMonthItem:function(t,e,n,s,r,i){var o=a('<span class="date" data-date="'+e+'" data-index="'+t+'"><span>'+e+"</span></span>");return t%7!==0&&t%7!==6||o.addClass("weekends"),e==r&&o.addClass("curr-date"),this.get("todayText")&&this.isToday(n,s,e)&&o.addClass("today-date small-font").children("span").html(this.get("todayText")),i&&i[e]&&o.addClass(i[e]),this.get("dateItems")[e]=o,o},getDatesData:function(t,e){for(var a=[],n=1,s=1,r=this.getLastDate(t,e),i=new Date(t,e-1,1).getDay(),o=r+i,h=(42-o)%7,d=this.getPreMonthDates(t,e,i),l=0;l<r+h;l++)l<r?a[l]=n++:a[l]=s++;var c={datesArr:d.concat(a),lastDate:r,preMonthDates:i,nextMonthDates:h};return this.set("datesData",c),c},getPreMonthDates:function(t,e,a){var n,s=[];if(!a||0===a)return s;for(n=new Date(t,e-1,0).getDate();a;)s.unshift(n--),a--;return s},parseTagDates:function(t){var e,a,n={};if(this.isArray(t))for(e=0,a=t.length;e<a;e++)n[t[e]]="tag";else if(t instanceof Object)for(var s in t)if(this.isArray(t[s]))for(e=0,a=t[s].length;e<a;e++)n[t[s][e]]=s;return n},destroy:function(){this._$elem.off(),this._$elem.remove(),this.fire("destroy")},reDrawCalendar:function(t,e,a){a=a||this.getSelectedDate();var n=this.checkeDate(t,e,a);if(n){this.set("dateItems",{});var s=this.tplCalendar(n.year,n.month,a),r=this.find(".date-wrap");this._adjustTime(n.year,n.month,a),this.updateTitleTime(n.year,n.month),r.html(s.children()),this.fire("reDrawCalendar",this.getCurrDateObj())}},checkeDate:function(t,e,a){var n=new Date(t,+e-1,a),t=n.getFullYear();return!isNaN(t)&&{year:t,month:n.getMonth()+1,date:n.getDate()}},getDateItem:function(t){return this.get("dateItems")[t]},getSelectedDate:function(){return this.getCurrDateObj().date},getLastDate:function(t,e){return new Date(t,e,0).getDate()},getToday:function(){var t=this.get("today");if(t)return t;var e=new Date;return t={year:e.getFullYear(),month:e.getMonth()+1,date:e.getDate()}},isToday:function(t,e,a){var n=this.getToday();return t==n.year&&e==n.month&&a==n.date},getCurrDateObj:function(t){var e=this;return{year:this.get("year"),month:this.get("month"),date:this.get("date"),type:t,tag:function(t){console.log("tagDates"+t),e.set("tagDates",t),e.reDrawCalendar(e.get("year"),e.get("month"),e.get("date"))}}},isArray:function(t){return"[object Array]"==Object.prototype.toString.call(t)},preMonth:function(t){this._preMon(t)},nextMonth:function(t){this._nextMon(t)},today:function(){this._onToday()},select:function(t,e,a){if(t&&"number"==typeof t){if(e=e||this.getDateItem(t),!e.hasClass("curr-date")){var n=this.getLastDate(this.get("year"),this.get("month"));t>n?t=n:t<-n?t=1:-n<t&&t<0&&(t+=n),this.find(".curr-date").removeClass("curr-date"),e.addClass("curr-date"),this.set("date",t)}this.fire("select",this.getCurrDateObj(),a)}},takeTags:function(t){var e=this.parseTagDates(t),a=this.find(".date");for(var n in e)a.eq(n-1).addClass(e[n])}}),n});